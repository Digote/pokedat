name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if (Test-Path "requirements.txt") {
            pip install -r requirements.txt
          }
          pip install pyinstaller

      - name: Build executable
        run: |
          pyinstaller --onefile --name pokedat main.py

      - name: Package artifacts
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}"
          $zipPath = "dist/pokedat-$version-win64.zip"
          $exePath = "dist/pokedat-$version-win64.exe"
          Copy-Item -Path "dist/pokedat.exe" -Destination $exePath -Force
          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
          Compress-Archive -Path $exePath -DestinationPath $zipPath

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            dist/pokedat-${{ github.ref_name }}-win64.exe
            dist/pokedat-${{ github.ref_name }}-win64.zip
